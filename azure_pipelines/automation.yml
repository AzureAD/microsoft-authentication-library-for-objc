variables:
  - name: 'repositoryName' # Name of the repository
    value: 'AzureAD/microsoft-authentication-library-for-objc'

schedules:
# daily build will only be triggered if there is any change between the build and last successful build
- cron: "0 4 * * *"
  displayName: Daily 8 pm build
  branches:
    include:
    - dev
- cron: "0 20 * * 0"
  displayName: Weekly Sunday build
  branches:
    include:
    - dev
  always: true

trigger:
  branches:
      include:
      - release/*
      - hotfix/*

pr: none

pool:
  vmImage: 'macOS-13'

jobs:

- template: templates/tests-with-conf-file.yml

- job: cocoapods_lib_lint
  displayName: Run Cocoapods lib lint
  timeoutInMinutes: 30
  cancelTimeoutInMinutes: 5
  strategy:
    maxParallel: 2
    matrix:
      STATIC_LIBRARY: 
        args: "--fail-fast --swift-version=5 --allow-warnings --use-static-frameworks"
      DYNAMIC_LIBRARY: 
        args: "--fail-fast --swift-version=5 --allow-warnings"
  workspace:
    clean: all
  
  steps:

  - checkout: self
    clean: true
    submodules: true
    fetchDepth: 1
    persistCredentials: true
    path: s

  - task: Bash@3
    displayName: Replace HEADER_SEARCH_PATHS for NativeAuth subspec in MSAL.podspec 
    inputs:
      targetType: 'inline'
      script: |
        sed -i '' 's/"$SRCROOT\/MSAL"/__dir__/' MSAL.podspec
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: Bash@3
    displayName: Run pod lib lint 
    inputs:
      targetType: 'inline'
      script: |
        pod lib lint $(args)
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: Bash@3
    displayName: Discard temporary changes made to MSAL.podspec 
    inputs:
      targetType: 'inline'
      script: |
        git checkout -f -- MSAL.podspec
      workingDirectory: '$(Build.SourcesDirectory)'