parameters:
  schema: ''
  build: ''

steps:
  - checkout: self
    clean: true
    submodules: true
    fetchDepth: 1
    persistCredentials: true
    path: s
    
  - task: Bash@3
    displayName: 'Select Xcode version'
    inputs:
      targetType: 'inline'
      script: '/bin/bash -c "sudo xcode-select -s /Applications/Xcode_15.4.app"'
  
  - task: Bash@3
    displayName: Go to project folder
    inputs:
      targetType: 'inline'
      script: |        
        cd $(Agent.BuildDirectory)/s
  
  - script: 'gem install xcpretty'
    displayName: 'Install xcpretty'

  - task: AzureCLI@2
    displayName: 'Read configuration from KeyVault'
    inputs:
      azureSubscription: 'AuthSdkResourceManager'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: 'python get_automation_conf_file.py'
      workingDirectory: azure_pipelines/scripts/
  - task: Bash@3
    displayName: Build for testing
    inputs:
      targetType: 'inline'
      script: |
        mv azure_pipelines/scripts/conf.json MSAL/test/automation/conf.json
        ruby TestRubyFile.rb
        xcodebuild build-for-testing \
          -workspace MSAL.xcworkspace \
          -scheme '${{ parameters.schema }}' \
          -sdk macosx \
          -destination 'platform=macOS' \
          -derivedDataPath 'build' \
          | tee xcodebuild.log \
          | xcpretty -c
  - task: Bash@3
    displayName: Run automations
    inputs:
      targetType: 'inline'
      script: |
        # Get the macOS version
        macos_version=$(sw_vers -productVersion)
        echo "Mac Version $macos_version"      
        full_path="build/Build/Products/${{ parameters.build }}_macosx$macos_version-x86_64.xctestrun"
        ls build/Build/Products/
        xcodebuild test-without-building \
            -xctestrun "$full_path" \
            -destination 'platform=macOS' \
            -retry-tests-on-failure \
            -parallel-testing-enabled NO \
            -resultBundlePath '$(Agent.BuildDirectory)/s/test_output_mac/report-mac.xcresult'       

  # https://learn.microsoft.com/en-us/azure/devops/pipelines/artifacts/pipeline-artifacts?view=azure-devops&tabs=yaml#q-can-i-delete-pipeline-artifacts-when-re-running-failed-jobs
  - task: PublishPipelineArtifact@1
    condition: succeededOrFailed()
    inputs:
      targetPath: '$(Agent.BuildDirectory)/s/test_output_mac/'
      artifactName: 'TestOutputs Attempt - $(System.StageAttempt) - ${{ parameters.schema }}'
      publishLocation: 'pipeline'
  